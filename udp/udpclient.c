/*
 * From https://gist.github.com/suyash/0f100b1518334fcf650bbefd54556df9
 *
 * Refactored by NHP
 */
#include <arpa/inet.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/socket.h>
#include <sys/types.h>

#include <unistd.h>
#include <time.h>
#include <sys/select.h>


#define BUF_SIZE    8192

int main(int argc, char *argv[]) {
  //const char* server_name = "localhost";  
  long double timer;
  in_addr_t ip_addr;
  if(argc <=2){
    printf("please give an ip addr & a timeout value");
    return -99;
  }
  else{
		ip_addr = inet_addr(argv[1]);
    timer = atof(argv[2]);

  }
  const int server_port = 8888;

  struct sockaddr_in server_address;
  
  char buffer[BUF_SIZE+1];
  char *data_to_send = buffer;
  
  memset(&server_address, 0, sizeof(server_address));
  server_address.sin_family = AF_INET;

  // creates binary representation of server name
  // and stores it as sin_addr
  // http://beej.us/guide/bgnet/output/html/multipage/inet_ntopman.html
  //inet_pton(AF_INET, server_name, &server_address.sin_addr);

  server_address.sin_addr.s_addr = htonl( INADDR_LOOPBACK );
  // htons: port in network order format
  server_address.sin_port = htons(server_port);
	server_address.sin_addr.s_addr=ip_addr;
  // open socket
  int sock;
  if ((sock = socket(PF_INET, SOCK_DGRAM, 0)) < 0) {
    printf("could not create socket\n");
    return 1;
  }
	struct timeval timev;
	fd_set rfds;

  // Loop here until we get a SIGHUP or other interrupting signal
  for (;;) {
	printf("\n");
    printf("Prompt> ");
    memset( data_to_send, 0x00, BUF_SIZE + 1);
	fgets(data_to_send, BUF_SIZE , stdin) ;
	if(strlen(data_to_send)>=BUF_SIZE){
	 	data_to_send[strlen(data_to_send) - 1] = 0x00;    
	}

    //after the user defined function does its work
    // send data
    int len =
        sendto(sock, data_to_send, strlen(data_to_send), 0,
               (struct sockaddr*)&server_address, sizeof(server_address));
	printf("%s",data_to_send);
	timev.tv_sec=timer;
	timev.tv_usec=0;

    FD_ZERO(&rfds);
    FD_SET(sock, &rfds);
	time_t start = time(NULL);
	int s = select(5, &rfds, NULL, NULL, &timev);
	time_t end = time(NULL);
    if (s == -1)
        perror("select failed!");
    else if (s){
		ssize_t r=recvfrom(sock, buffer, len, 0, NULL, NULL);
		if(r==0){
			printf("No packets?");
		} else if(r==-1){
			printf("error in recvfrom");
		}
		printf("status: SUCCESSES\n");
		buffer[len] = '\0';
		printf("reply: '%s'\n", buffer);
	}
	else if(s==0){
        printf("Status: TIMEOUT\n");
	}
		printf("Select: %d",s);
		int diff = (end-start);
	printf("\n time : %d\n",diff);
	

    // data that will be sent to the server
    // fgets(data_to_send, BUF_SIZE, stdin);
    // remove trailing \n from the user input
   

  }
  
  // close the socket
  close(sock);
  return 0;
}
/*small message

000102030405060708091011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798990001020304050607080910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697989900010203040506070809101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899
*/

/*large message

00010203040506070809101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899000102030405060708091011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798990001020304050607080910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697989900010203040506070809101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899000102030405060708091011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798990001020304050607080910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697989900010203040506070809101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899000102030405060708091011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798990001020304050607080910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697989900010203040506070809101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899000102030405060708091011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798990001020304050607080910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697989900010203040506070809101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899000102030405060708091011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798990001020304050607080910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697989900010203040506070809101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899000102030405060708091011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798990001020304050607080910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697989900010203040506070809101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899000102030405060708091011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798990001020304050607080910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697989900010203040506070809101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899000102030405060708091011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798990001020304050607080910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697989900010203040506070809101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899
*/
